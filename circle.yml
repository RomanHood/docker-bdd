machine:
  ruby:
    version: 2.1.2
  services:
    - docker

dependencies:
  override:
    - sudo pip install git+http://github.com/btaitelb/fig.git@notail
    - fig up -d
    - fig run dev bundle install
    - gem install cucumber

test:
  override:
    - cucumber
  post:
    - fig logs --no-tail > ${CIRCLE_ARTIFACTS}/fig.log
    - cp example/rails/log/* ${CIRCLE_ARTIFACTS}
    
deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p "${DOCKER_PASS}"
      - for image in `fig ps | grep Up | cut -d ' ' -f 1`; do IMG=`echo ${CIRCLE_PROJECT_USERNAME}/$image | sed -r 's/_[0-9]+$//'`; SHA=${CIRCLE_SHA1:0:7}; docker tag ${image}:latest $IMG:$SHA; docker push $IMG:$SHA; done

