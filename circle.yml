machine:
  ruby:
    version: 2.1.2
  services:
    - docker

dependencies:
  override:
    - sudo pip install fig
    - fig up -d
    - gem install cucumber

test:
  override:
    - cucumber --format json --out $CIRCLE_TEST_REPORTS/cucumber/tests.cucumber

deployment:
  hub:
    branch: master
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - for image in `fig ps | grep Up | cut -d ' ' -f 1 | sed -r 's/_[0-9]+$//'`; do docker push ${CIRCLE_PROJECT_USERNAME}/${image}:${CIRCLE_SHA1:0:7}

